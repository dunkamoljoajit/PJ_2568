<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AUTONURSESHIFT - ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f7fafc; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 1rem); }

        /* Animations */
        @keyframes countUp { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .stat-number { animation: countUp 0.5s ease-out forwards; }

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(5px); } 
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }

        @keyframes fade-in-up {
            from { opacity:0; transform:translateY(8px); }
            to { opacity:1; transform:translateY(0); }
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.25s ease-out both;
        }

        .logo-text {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1e2a78;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800">
<div class="flex flex-col h-screen relative">

<!-- Header -->
<header class="sticky top-0 z-40 bg-white/90 backdrop-blur-md border-b border-gray-100 shadow-sm">
    <div class="max-w-screen-md mx-auto px-4 py-3">
        <div class="flex justify-between items-center">
            
            <a href="dashboard.html" class="flex items-center gap-2 hover:opacity-80 transition-opacity">
                <img src="logo.png" class="w-9 h-9 object-contain drop-shadow-sm">
                <span class="logo-text">AUTONURSESHIFT</span>
            </a>

            <div class="flex items-center gap-3">
                <div class="text-right hidden sm:block">
                    <h1 class="text-sm font-bold text-gray-700">
                        <span id="user-name">
                            <span class="animate-pulse bg-gray-200 h-4 w-20 block rounded"></span>
                        </span>
                    </h1>
                    <p class="text-[10px] font-medium text-gray-400" id="current-date">...</p>
                </div>

                <div class="relative">
                    <button id="profile-menu-btn" class="flex items-center">
                        <img id="header-profile-img"
                             class="w-10 h-10 rounded-full border-2 border-white shadow-md object-cover ring-2 ring-indigo-50 hover:ring-indigo-200 transition-all"
                             src="https://placehold.co/100x100/EBF4FF/7F8_?text=U&font=kanit">
                             <span class="absolute -bottom-0.5 -right-0.5 h-2.5 w-2.5 bg-green-500 border-2 border-white rounded-full"></span>
                    </button>

                    <div id="profile-dropdown" class="hidden absolute right-0 mt-3 w-48 bg-white rounded-xl shadow-xl border border-gray-100 z-50 animate-fade-in-up">
                        <div class="p-1">
                            <a href="profile-edit.html" class="flex items-center px-3 py-2 text-sm text-gray-600 rounded-lg hover:bg-indigo-50 hover:text-indigo-700">
                                <div class="w-7 h-7 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center mr-2">
                                    <i class="fas fa-user-edit text-xs"></i>
                                </div>
                                ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
                            </a>
                        </div>

                        <div class="border-t border-gray-100 my-1"></div>

                        <div class="p-1">
                            <button id="logout-btn" class="w-full flex items-center px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg">
                                <div class="w-7 h-7 rounded-full bg-red-100 text-red-500 flex items-center justify-center mr-2">
                                    <i class="fas fa-sign-out-alt text-xs"></i>
                                </div>
                                ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</header>

<!-- Main Content -->
<main class="flex-1 overflow-y-auto pb-28">
    <div class="max-w-screen-md mx-auto p-4 md:p-6 space-y-6">

        <!-- Upcoming Shift -->
        <div class="bg-white rounded-2xl shadow-sm p-5 border border-gray-100">
            <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fas fa-clock text-indigo-500"></i> ‡πÄ‡∏ß‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á
            </h2>

            <div id="upcoming-shift-container" class="space-y-3">
                <div class="animate-pulse flex space-x-4 p-4 border border-gray-100 rounded-lg">
                    <div class="flex-1 space-y-2 py-1">
                        <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                        <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                    </div>
                    <div class="h-8 bg-gray-200 rounded w-16"></div>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-white rounded-2xl shadow-sm p-4 text-center border border-gray-100">
                <div class="stat-number text-3xl font-bold text-indigo-600" id="total-month">-</div>
                <p class="text-xs text-gray-400 mt-1">‡πÄ‡∏ß‡∏£‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</p>
            </div>

            <div class="bg-white rounded-2xl shadow-sm p-4 text-center border border-gray-100">
                <div class="stat-number text-3xl font-bold text-blue-500" id="total-week">-</div>
                <p class="text-xs text-gray-400 mt-1">‡πÄ‡∏ß‡∏£‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</p>
            </div>

            <div class="bg-white rounded-2xl shadow-sm p-4 text-center border border-gray-100">
                <div class="stat-number text-3xl font-bold text-amber-500" id="pending-exchange">-</div>
                <p class="text-xs text-gray-400 mt-1">‡∏£‡∏≠‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</p>
            </div>

            <div class="bg-white rounded-2xl shadow-sm p-4 text-center border border-gray-100">
                <div class="stat-number text-3xl font-bold text-rose-500" id="pending-trade">-</div>
                <p class="text-xs text-gray-400 mt-1">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ç‡∏≤‡∏¢</p>
            </div>
        </div>

        <!-- Action Card -->
        <div class="bg-gradient-to-r from-indigo-600 to-blue-500 rounded-2xl shadow-lg p-6 text-white">
            <h2 class="text-lg font-bold mb-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
            <p class="text-sm opacity-90 mb-4">‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏•‡∏Å‡πÄ‡∏ß‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡∏≠‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>

            <div class="flex gap-3">
                <a href="schedule.html" class="bg-white text-indigo-600 text-sm font-bold py-2 px-4 rounded-lg shadow hover:bg-gray-50 transition">
                    ‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£
                </a>
                <a href="request-exchange.html" class="bg-indigo-700 text-white text-sm font-bold py-2 px-4 rounded-lg hover:bg-indigo-800 transition">
                    ‡∏Ç‡∏≠‡πÅ‡∏•‡∏Å‡πÄ‡∏ß‡∏£
                </a>
            </div>
        </div>

    </div>
</main>


<!-- Constraint Button -->
<button id="constraintBtn" class="hidden fixed bottom-24 right-5 w-14 h-14 bg-red-500 hover:bg-red-600 text-white rounded-full shadow-lg flex items-center justify-center z-40">
    <i class="fas fa-calendar-times text-xl"></i>
</button>

<!-- Footer -->
<footer class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 pb-safe">
    <div class="max-w-screen-md mx-auto grid grid-cols-5">
        <a class="flex flex-col items-center justify-center p-3 text-indigo-600 bg-indigo-50/50">
            <i class="fas fa-home text-xl mb-1"></i><span class="text-[10px]">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
        </a>
        <a href="swap_request.html" class="flex flex-col items-center justify-center p-3 text-gray-400 hover:text-indigo-600">
            <i class="fas fa-exchange-alt text-xl mb-1"></i><span class="text-[10px]">‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</span>
        </a>
        <a href="#" class="flex flex-col items-center justify-center p-3 text-gray-400 hover:text-indigo-600">
            <i class="fas fa-shopping-cart text-xl mb-1"></i><span class="text-[10px]">‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢</span>
        </a>
        <a href="#" class="flex flex-col items-center justify-center p-3 text-gray-400 hover:text-indigo-600">
            <i class="fas fa-chart-pie text-xl mb-1"></i><span class="text-[10px]">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</span>
        </a>
        <a href="schedule.html" class="flex flex-col items-center justify-center p-3 text-gray-400 hover:text-indigo-600">
            <i class="fas fa-calendar-alt text-xl mb-1"></i><span class="text-[10px]">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£</span>
        </a>
    </div>
</footer>

</div>


<script>
const API_BASE = 'http://127.0.0.1:3000';

document.addEventListener('DOMContentLoaded', () => {
    const storedUser = localStorage.getItem('user');

    if (!storedUser) return window.location.href = 'login.html';

    const userObj = JSON.parse(storedUser);

    if (parseInt(userObj.RoleID) !== 2) {
        alert("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ");
        return window.location.href = 'login.html';
    }

    updateCurrentDate();
    loadDashboardData();
    setupProfileMenu();
    checkConstraintWindow();
    setupAutoLogout();
});


function updateCurrentDate() {
    const dateElement = document.getElementById('current-date');
    const now = new Date();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    dateElement.innerText = now.toLocaleDateString('th-TH', options);
}


async function loadDashboardData() {
    const storedUser = localStorage.getItem('user');
    if (!storedUser) return;

    const userId = JSON.parse(storedUser).UserID;

    try {
        const response = await fetch(`${API_BASE}/api/dashboard-summary`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId })
        });

        const data = await response.json();

        if (!data.success) {
            alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
            return;
        }

        document.getElementById('user-name').innerText = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ${data.userData.fullName} üëã`;

        if (data.userData.profileImage) {
            document.getElementById('header-profile-img').src =
                `${API_BASE}/uploads/${data.userData.profileImage}?t=${Date.now()}`;
        }

        document.getElementById('total-month').innerText = data.stats.totalMonth;
        document.getElementById('total-week').innerText = data.stats.totalWeek;
        document.getElementById('pending-exchange').innerText = data.stats.pendingExchange;
        document.getElementById('pending-trade').innerText = data.stats.pendingTrade;

        renderUpcomingShifts(data.upcomingShifts);

    } catch (error) {
        console.error(error);
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    }
}


function renderUpcomingShifts(shifts) {
    const container = document.getElementById('upcoming-shift-container');
    container.innerHTML = '';

    const valid = shifts?.filter(s => s.Nurse_Date && s.ShiftName) || [];

    if (!valid.length) {
        container.innerHTML = `
            <div class="text-center py-6 fade-in">
                <div class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-mug-hot text-2xl text-gray-300"></i>
                </div>
                <p class="text-sm text-gray-500">‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏£‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ</p>
            </div>`;
        return;
    }

    valid.forEach(shift => {
        const dateObj = new Date(shift.Nurse_Date);
        const dateStr = dateObj.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' });

        const start = shift.StartTime?.slice(0,5) || '--:--';
        const end = shift.EndTime?.slice(0,5) || '--:--';

        let color = 'border-blue-500 bg-blue-50 text-blue-600';
        if (shift.ShiftName.includes('‡∏ö‡πà‡∏≤‡∏¢')) color = 'border-orange-500 bg-orange-50 text-orange-600';
        if (shift.ShiftName.includes('‡∏î‡∏∂‡∏Å')) color = 'border-purple-500 bg-purple-50 text-purple-600';

        container.insertAdjacentHTML('beforeend', `
            <div class="flex justify-between items-center p-3 rounded-lg ${color} fade-in border">
                <div>
                    <div class="font-semibold">${shift.ShiftName}</div>
                    <div class="text-xs opacity-70">${dateStr} | ${start} - ${end}</div>
                </div>
                <div class="text-sm font-medium">${shift.WardName || '-'}</div>
            </div>
        `);
    });
}


async function checkConstraintWindow() {
    const btn = document.getElementById('constraintBtn');
    try {
        const res = await fetch(`${API_BASE}/api/check-constraint-window`);
        const data = await res.json();
        btn.classList.toggle('hidden', !data.isOpen);
    } catch {
        btn.classList.add('hidden');
    }
}


function setupProfileMenu() {
    const btn = document.getElementById('profile-menu-btn');
    const menu = document.getElementById('profile-dropdown');
    const logoutBtn = document.getElementById('logout-btn');

    btn.addEventListener('click', () => menu.classList.toggle('hidden'));
    
    document.addEventListener('click', e => {
        if (!btn.contains(e.target) && !menu.contains(e.target)) {
            menu.classList.add('hidden');
        }
    });

    logoutBtn.addEventListener('click', () => handleLogout());
}


async function handleLogout() {
    const confirmLogout = confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?");
    if (!confirmLogout) return;

    const storedUser = localStorage.getItem('user');
    if (storedUser) {
        const { UserID } = JSON.parse(storedUser);
        await fetch(`${API_BASE}/api/logout`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: UserID }),
            keepalive: true
        });
    }

    localStorage.removeItem('user');
    window.location.href = 'login.html';
}


function setupAutoLogout() {
    let timer;
    const timeout = 15 * 60 * 1000;

    function reset() {
        clearTimeout(timer);
        timer = setTimeout(() => {
            alert("‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (15 ‡∏ô‡∏≤‡∏ó‡∏µ)\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥");
            handleLogout();
        }, timeout);
    }

    ['click','mousemove','keypress','scroll','touchstart']
        .forEach(ev => document.addEventListener(ev, reset, { passive: true }));

    reset();
}
</script>

</body>
</html>
